<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout/head :: head"></head>

<body class="d-flex flex-column min-vh-100">

<!-- í—¤ë” -->
<div th:replace="layout/header :: header"></div>

<!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div class="container flex-grow-1 mt-5 mb-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h3>
        <a th:href="@{/product/list}" class="btn btn-secondary">
            ìƒí’ˆ ëª©ë¡ìœ¼ë¡œ
        </a>
    </div>

    <!-- ì¥ë°”êµ¬ë‹ˆ í…Œì´ë¸” -->
    <div class="table-responsive" th:if="${!#lists.isEmpty(items)}">
        <table class="table table-bordered table-hover align-middle text-center">
            <thead class="table-light">
                <tr>
                    <th>ì´ë¯¸ì§€</th>
                    <th>ìƒí’ˆëª…</th>
                    <th>ê°€ê²©</th>
                    <th>ìˆ˜ëŸ‰</th>
                    <th>í•©ê³„</th>
                    <th>ì‚­ì œ</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="item : ${items}">
                    <td>
                        <img th:src="${item.imageUrl}"
                             style="width:80px; height:80px; object-fit:cover;"
                             alt="ìƒí’ˆ ì´ë¯¸ì§€">
                    </td>

                    <td th:text="${item.productName}">ìƒí’ˆëª…</td>

                    <td th:text="${T(java.lang.String)
                         .format('%,dì›', item.price)}">
                    </td>

                    <td th:text="${item.quantity}">ìˆ˜ëŸ‰</td>

                    <td th:text="${T(java.lang.String)
                         .format('%,dì›', item.price * item.quantity)}">
                    </td>

                    <td>
                        <button class="btn btn-sm btn-danger"
                                th:onclick="'deleteCartItem(' + ${item.id} + ')'">
                            ì‚­ì œ
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- âœ… ì´ ê¸ˆì•¡ ì˜ì—­ -->
        <div class="text-end mt-4">
            <h4>
                ì´ ê²°ì œ ê¸ˆì•¡ :
                <span th:text="${T(java.lang.String)
                     .format('%,dì›', totalPrice)}">
                </span>
            </h4>

            <button class="btn btn-primary mt-2"
                    onclick="createOrder()">
                ê²°ì œí•˜ê¸°
            </button>
        </div>
    </div>

    <!-- ì¥ë°”êµ¬ë‹ˆ ë¹„ì—ˆì„ ë•Œ -->
    <div class="text-center mt-5" th:if="${#lists.isEmpty(items)}">
        <p class="text-muted">ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <a th:href="@{/product/list}" class="btn btn-primary mt-3">
            ìƒí’ˆ ë³´ëŸ¬ ê°€ê¸°
        </a>
    </div>

</div>

<!-- í‘¸í„° -->
<div th:replace="layout/footer :: footer"></div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>

    async function deleteCartItem(itemId) {
        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            await axios.post('/cart/delete', null, {
                params: {
                    itemId: itemId
                }
            });

            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            location.reload();

        } catch (err) {
            console.error(err);
            alert(err.response?.data?.message || 'ì‚­ì œ ì‹¤íŒ¨');
        }
    }

    async function createOrder() {
        if (!confirm('ê²°ì œë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const response = await axios.post('/order/create');
            const orderId = response.data;

            alert('ì£¼ë¬¸ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
            location.href = `/payment?orderId=${orderId}`;

        } catch (err) {
            console.error(err);
            alert(err.response?.data?.message || 'ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨');
        }
    }

</script>

</body>
</html>