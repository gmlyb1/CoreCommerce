<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout/head :: head"></head>
<body class="d-flex flex-column min-vh-100">

<div th:replace="layout/header :: header"></div>

<div class="container flex-grow-1 mt-5 mb-5 text-center">

    <h3>💳 결제 페이지</h3>

    <div class="mt-4">
        <p>주문번호 :
            <b th:text="${order.id}">0</b>
        </p>
        <p>결제금액 :
            <b th:text="${T(java.lang.String).format('%,d원', order.totalPrice)}">
                0원
            </b>
        </p>
    </div>

    <!-- ✅ v2에서 반드시 필요 -->
    <div class="mt-4" id="payment-method"></div>
    <div class="mt-3" id="agreement"></div>

    <button class="btn btn-primary mt-4" id="payBtn">
        결제 진행
    </button>

</div>

<div th:replace="layout/footer :: footer"></div>

<script src="https://js.tosspayments.com/v2/standard"></script>

<script th:inline="javascript">
/*<![CDATA[*/

const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";

const rawOrderId = /*[[${order != null ? order.id : 0}]]*/ 0;
const amount = /*[[${order != null ? order.totalPrice : 0}]]*/ 0;

let widgets;

// ✅ v2 초기화 방식
async function init() {

    const tossPayments = TossPayments(clientKey);

    widgets = tossPayments.widgets({
        customerKey: "CUSTOMER_" + rawOrderId
    });

    await widgets.setAmount({
        currency: "KRW",
        value: amount
    });

    await widgets.renderPaymentMethods({
        selector: "#payment-method"
    });

    await widgets.renderAgreement({
        selector: "#agreement"
    });
}

init();

document.getElementById("payBtn").addEventListener("click", async function () {

    try {
        await widgets.requestPayment({
        	orderId: "ORDER_" + rawOrderId,
            orderName: "CoreCommerce 주문",
            successUrl: window.location.origin + "/payment/success",
            failUrl: window.location.origin + "/payment/fail"
        });
    } catch (error) {
        console.error(error);
        alert("결제 요청 중 오류가 발생했습니다.");
    }

});

/*]]>*/
</script>

</body>
</html>