<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/head :: head"></head>

<body class="bg-light">

<div th:replace="layout/header :: header"></div>


<div class="container py-5">

    <div class="card shadow-lg border-0 rounded-4 p-5">

        <div class="row g-5">

            <!-- ================= 왼쪽 : 이미지 ================= -->
            <div class="col-md-6 text-center">

                <div class="position-relative">

                    <img th:src="${product.imageUrl}"
                         class="img-fluid rounded-4 shadow-sm"
                         style="max-height:450px; object-fit:cover;">

                    <!-- 품절 배지 -->
                    <span class="badge bg-danger position-absolute top-0 end-0 m-3"
                          th:if="${product.stock == 0}">
                        품절
                    </span>

                </div>

            </div>


            <!-- ================= 오른쪽 : 상품 정보 ================= -->
            <div class="col-md-6">

                <!-- 상품명 -->
                <h2 class="fw-bold mb-3"
                    th:text="${product.name}">
                </h2>


                <!-- 가격 영역 -->
                <div class="mb-4">

                    <div class="text-muted text-decoration-line-through"
                         th:if="${product.originalPrice != null}"
                         th:text="|₩ ${#numbers.formatInteger(product.originalPrice,3,'COMMA')}|">
                    </div>

                    <h3 class="text-danger fw-bold"
                        th:text="|₩ ${#numbers.formatInteger(product.price,3,'COMMA')}|">
                    </h3>

                </div>


                <!-- 재고 -->
                <div class="mb-3">

                    <span class="badge bg-success"
                          th:if="${product.stock > 0}">
                        재고 있음
                    </span>

                    <span class="badge bg-danger"
                          th:if="${product.stock == 0}">
                        품절
                    </span>

                </div>


                <!-- 상품 설명 -->
                <div class="border-top pt-3 mb-4">

                    <h6 class="fw-bold">상품 설명</h6>

                    <p class="text-muted"
                       style="white-space:pre-line;"
                       th:text="${product.description}">
                    </p>

                </div>


                <!-- 수량 -->
                <div class="mb-4">

                    <label class="form-label fw-semibold">수량</label>

                    <input type="number"
                           id="quantity"
                           class="form-control w-50"
                           value="1"
                           min="1"
                           th:max="${product.stock}">

                </div>


                <!-- 버튼 -->
                <div class="d-grid gap-3">

                    <button class="btn btn-dark py-3 fw-bold"
                            th:disabled="${product.stock == 0}"
                            th:onclick="'addToCart(' + ${product.id} + ')'">
                        🛒 장바구니 담기
                    </button>

                    <button class="btn btn-outline-danger py-3"
                            th:onclick="'toggleWishlist(' + ${product.id} + ')'">
                        ❤️ 찜하기
                    </button>

                    <a href="/product/list"
                       class="btn btn-outline-secondary py-3">
                        ← 목록으로
                    </a>

                </div>


                <!-- 관리자 버튼 -->
                <div class="mt-4 text-end"
                     th:if="${loginUser.role == 'MANAGER' or loginUser.role == 'PRODUCTER'}">

                    <a th:href="@{/product/form(id=${product.id})}"
                       class="btn btn-sm btn-outline-primary">
                        수정
                    </a>

                    <button class="btn btn-sm btn-outline-danger"
                            th:onclick="'deleteProduct(' + ${product.id} + ')'">
                        삭제
                    </button>

                </div>

            </div>

        </div>


        <!-- ================= 추가 정보 섹션 ================= -->
        <div class="mt-5 border-top pt-4">

            <h4 class="fw-bold mb-3">📦 배송 정보</h4>

            <ul class="text-muted">
                <li>🚚 평균 배송기간 : 2~3일</li>
                <li>💳 결제 완료 후 출고</li>
                <li>🔄 7일 이내 반품 가능</li>
            </ul>

        </div>


        <!-- ================= 리뷰 섹션 ================= -->
        <div class="mt-5 border-top pt-4">

            <h4 class="fw-bold mb-3">⭐ 상품 후기</h4>

            <div class="text-muted">
                <p>등록된 리뷰가 없습니다.</p>
            </div>

        </div>

    </div>

</div>


<!-- ================= JS ================= -->
<script>

function deleteProduct(id) {
    if (!confirm("정말 삭제하시겠습니까?")) return;

    fetch("/product/" + id, { method: "DELETE" })
        .then(() => {
            alert("삭제되었습니다.");
            location.href = "/product/list";
        });
}

function addToCart(productId) {

    const quantity = document.getElementById("quantity").value;

    fetch("/cart/add?productId=" + productId + "&quantity=" + quantity, {
        method: "POST"
    })
    .then(() => {
        if (confirm("장바구니에 추가되었습니다.\n장바구니로 이동하시겠습니까?")) {
            location.href = "/cart/list";
        }
    });
}

function toggleWishlist(productId) {

    fetch("/wishlist/toggle", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: "productId=" + productId
    })
    .then(res => {
        if (res.status === 401) {
            alert("로그인이 필요합니다.");
            location.href = "/login";
            return;
        }
        return res.json();
    })
    .then(liked => {

        alert(liked ? "❤️ 찜 추가" : "🤍 찜 취소");

    })
    .catch(() => alert("오류 발생"));

}

</script>


<div th:replace="layout/footer :: footer"></div>

</body>
</html>