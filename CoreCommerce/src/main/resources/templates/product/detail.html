<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/head :: head"></head>

<body class="bg-light">

<div th:replace="layout/header :: header"></div>


<div class="container py-5">

    <div class="card shadow-lg border-0 rounded-4 p-5">

        <div class="row g-5">

            <!-- ================= ì™¼ìª½ : ì´ë¯¸ì§€ ================= -->
            <div class="col-md-6 text-center">

                <div class="position-relative">

                    <img th:src="${product.imageUrl}"
                         class="img-fluid rounded-4 shadow-sm"
                         style="max-height:450px; object-fit:cover;">

                    <!-- í’ˆì ˆ ë°°ì§€ -->
                    <span class="badge bg-danger position-absolute top-0 end-0 m-3"
                          th:if="${product.stock == 0}">
                        í’ˆì ˆ
                    </span>

                </div>

            </div>


            <!-- ================= ì˜¤ë¥¸ìª½ : ìƒí’ˆ ì •ë³´ ================= -->
            <div class="col-md-6">

                <!-- ìƒí’ˆëª… -->
                <h2 class="fw-bold mb-3"
                    th:text="${product.name}">
                </h2>


                <!-- ê°€ê²© ì˜ì—­ -->
                <div class="mb-4">

                    <div class="text-muted text-decoration-line-through"
                         th:if="${product.originalPrice != null}"
                         th:text="|â‚© ${#numbers.formatInteger(product.originalPrice,3,'COMMA')}|">
                    </div>

                    <h3 class="text-danger fw-bold"
                        th:text="|â‚© ${#numbers.formatInteger(product.price,3,'COMMA')}|">
                    </h3>

                </div>


                <!-- ì¬ê³  -->
                <div class="mb-3">

                    <span class="badge bg-success"
                          th:if="${product.stock > 0}">
                        ì¬ê³  ìˆìŒ
                    </span>

                    <span class="badge bg-danger"
                          th:if="${product.stock == 0}">
                        í’ˆì ˆ
                    </span>

                </div>


                <!-- ìƒí’ˆ ì„¤ëª… -->
                <div class="border-top pt-3 mb-4">

                    <h6 class="fw-bold">ìƒí’ˆ ì„¤ëª…</h6>

                    <p class="text-muted"
                       style="white-space:pre-line;"
                       th:text="${product.description}">
                    </p>

                </div>


                <!-- ìˆ˜ëŸ‰ -->
                <div class="mb-4">

                    <label class="form-label fw-semibold">ìˆ˜ëŸ‰</label>

                    <input type="number"
                           id="quantity"
                           class="form-control w-50"
                           value="1"
                           min="1"
                           th:max="${product.stock}">

                </div>


                <!-- ë²„íŠ¼ -->
                <div class="d-grid gap-3">

                    <button class="btn btn-dark py-3 fw-bold"
                            th:disabled="${product.stock == 0}"
                            th:onclick="'addToCart(' + ${product.id} + ')'">
                        ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
                    </button>

                    <button class="btn btn-outline-danger py-3"
                            th:onclick="'toggleWishlist(' + ${product.id} + ')'">
                        â¤ï¸ ì°œí•˜ê¸°
                    </button>

                    <a href="/product/list"
                       class="btn btn-outline-secondary py-3">
                        â† ëª©ë¡ìœ¼ë¡œ
                    </a>

                </div>


                <!-- ê´€ë¦¬ì ë²„íŠ¼ -->
                <div class="mt-4 text-end"
                     th:if="${loginUser.role == 'MANAGER' or loginUser.role == 'PRODUCTER'}">

                    <a th:href="@{/product/form(id=${product.id})}"
                       class="btn btn-sm btn-outline-primary">
                        ìˆ˜ì •
                    </a>

                    <button class="btn btn-sm btn-outline-danger"
                            th:onclick="'deleteProduct(' + ${product.id} + ')'">
                        ì‚­ì œ
                    </button>

                </div>

            </div>

        </div>


        <!-- ================= ì¶”ê°€ ì •ë³´ ì„¹ì…˜ ================= -->
        <!-- ================= ë¦¬ë·° ì„¹ì…˜ ================= -->
<div class="mt-5 border-top pt-4">

    <h4 class="fw-bold mb-3">â­ ìƒí’ˆ í›„ê¸°</h4>

    <!-- ğŸ”¥ ë¦¬ë·° ì‘ì„± í¼ -->
    <div th:if="${loginUser != null}" class="mb-4">

        <form action="/review/add" method="post">

            <input type="hidden" name="productId"
                   th:value="${product.id}"/>

            <div class="mb-2">
                <textarea name="content"
                          class="form-control"
                          placeholder="ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ì„¸ìš”"
                          required></textarea>
            </div>

            <div class="mb-2">
                â­ ë³„ì  :
                <select name="rating" class="form-select w-25 d-inline">
                    <option value="5">â˜…â˜…â˜…â˜…â˜…</option>
                    <option value="4">â˜…â˜…â˜…â˜…</option>
                    <option value="3">â˜…â˜…â˜…</option>
                    <option value="2">â˜…â˜…</option>
                    <option value="1">â˜…</option>
                </select>
            </div>

            <button type="submit"
                    class="btn btn-dark btn-sm">
                ë¦¬ë·° ë“±ë¡
            </button>

        </form>

    </div>

    <!-- ğŸ”¥ ë¦¬ë·° ëª©ë¡ -->
	    <div>
	
	        <div th:if="${reviewList == null || reviewList.isEmpty()}">
	            <p class="text-muted">ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
	        </div>
	
	        <div th:each="review : ${reviewList}" class="border rounded p-3 mb-3">

			    <b th:text="${review.memberId}"></b>
			
			    â­ <span th:text="${review.rating}"></span>
			
			    <p th:text="${review.content}"></p>
			
			    <!-- ğŸ”¥ ë‚´ê°€ ì“´ ë¦¬ë·°ë©´ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ -->
			    <div th:if="${ review.memberId == loginUser.email}">
		
		        <!-- ìˆ˜ì • ë²„íŠ¼ -->
		        <button type="button"
		                class="btn btn-sm btn-warning"
		                th:onclick="|toggleEdit(${review.id})|">
		            ìˆ˜ì •
		        </button>

        <!-- ì‚­ì œ ë²„íŠ¼ -->
        <form action="/review/delete"  method="post" style="display:inline;">

            <input type="hidden" name="id"
                   th:value="${review.id}" />

            <input type="hidden" name="productId"
                   th:value="${product.id}" />

            <button class="btn btn-sm btn-danger">
                ì‚­ì œ
            </button>

        </form>
    </div>

    <!-- ğŸ”¥ ìˆ˜ì • í¼ (ìˆ¨ê¹€ ìƒíƒœ) -->
    <div th:id="'editForm-' + ${review.id}"
         style="display:none; margin-top:10px;">
        <form action="/review/update" method="post">
			            <input type="hidden" name="id"
			                   th:value="${review.id}" />
			            <input type="hidden" name="productId"
			                   th:value="${product.id}" />
			            <textarea name="content"
			                      class="form-control"
			                      th:text="${review.content}">
			            </textarea>
			            <select name="rating" class="form-select mt-2">
						    <option th:value="5"
						            th:selected="${review.rating == 5}">
						        â˜…â˜…â˜…â˜…â˜…
						    </option>
						
						    <option th:value="4"
						            th:selected="${review.rating == 4}">
						        â˜…â˜…â˜…â˜…
						    </option>
						
						    <option th:value="3"
						            th:selected="${review.rating == 3}">
						        â˜…â˜…â˜…
						    </option>
						
						    <option th:value="2"
						            th:selected="${review.rating == 2}">
						        â˜…â˜…
						    </option>
						
						    <option th:value="1"
						            th:selected="${review.rating == 1}">
						        â˜…
						    </option>
						</select>
			            <button class="btn btn-success btn-sm mt-2">
			                ì €ì¥
			            </button>
			        </form>
			    </div>
			</div>
	    </div>
	</div>
  </div>
</div>


<!-- ================= JS ================= -->
<script>

function deleteProduct(id) {
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    fetch("/product/" + id, { method: "DELETE" })
        .then(() => {
            alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.href = "/product/list";
        });
}

function addToCart(productId) {

    const quantity = document.getElementById("quantity").value;

    fetch("/cart/add?productId=" + productId + "&quantity=" + quantity, {
        method: "POST"
    })
    .then(() => {
        if (confirm("ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.\nì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            location.href = "/cart/list";
        }
    });
}

function toggleWishlist(productId) {

    fetch("/wishlist/toggle", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: "productId=" + productId
    })
    .then(res => {
        if (res.status === 401) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            location.href = "/login";
            return;
        }
        return res.json();
    })
    .then(liked => {

        alert(liked ? "â¤ï¸ ì°œ ì¶”ê°€" : "ğŸ¤ ì°œ ì·¨ì†Œ");

    })
    .catch(() => alert("ì˜¤ë¥˜ ë°œìƒ"));

}

function toggleEdit(id) {

    const form = document.getElementById("editForm-" + id);

    if (form.style.display === "none") {
        form.style.display = "block";
    } else {
        form.style.display = "none";
    }
}

</script>


<div th:replace="layout/footer :: footer"></div>

</body>
</html>