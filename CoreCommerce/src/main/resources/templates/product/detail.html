<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/head :: head"></head>

<body class="bg-light">

<div th:replace="layout/header :: header"></div>

<div class="container py-5">

    <div class="card shadow-lg border-0 rounded-4 p-4">
        <div class="row g-5">

            <!-- ÏôºÏ™Ω : ÏÉÅÌíà Ïù¥ÎØ∏ÏßÄ -->
            <div class="col-md-6 text-center">
                <img th:src="${product.imageUrl}"
                     class="img-fluid rounded shadow-sm"
                     style="max-height:450px; object-fit:cover;"
                     alt="ÏÉÅÌíà Ïù¥ÎØ∏ÏßÄ">
            </div>

            <!-- Ïò§Î•∏Ï™Ω : ÏÉÅÌíà Ï†ïÎ≥¥ -->
            <div class="col-md-6">

                <h2 class="fw-bold mb-3" th:text="${product.name}"></h2>

				<button id="wishBtn"
				        th:class="${isLiked} ? 'btn btn-danger' : 'btn btn-outline-danger'"
				        th:text="${isLiked} ? '‚ù§Ô∏è Ï∞ú Ï∑®ÏÜå' : 'ü§ç Ï∞úÌïòÍ∏∞'"
				        th:onclick="'toggleWishlist(' + ${product.id} + ')'">
				</button>

                <!-- Í∞ÄÍ≤© -->
                <h3 class="text-danger fw-bold mb-3"
                    th:text="|‚Ç© ${#numbers.formatInteger(product.price, 3, 'COMMA')}|">
                </h3>

                <!-- Ïû¨Í≥† ÏÉÅÌÉú -->
                <div class="mb-3">
                    <span class="badge bg-success"
                          th:if="${product.stock > 0}">
                        Ïû¨Í≥† ÏûàÏùå
                    </span>
                    <span class="badge bg-danger"
                          th:if="${product.stock == 0}">
                        ÌíàÏ†à
                    </span>
                </div>

                <!-- ÏÉÅÌíà ÏÑ§Î™Ö -->
                <p class="text-muted mb-4"
                   style="white-space:pre-line;"
                   th:text="${product.description}">
                </p>

                <!-- ÏàòÎüâ ÏÑ†ÌÉù -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">ÏàòÎüâ</label>
                    <input type="number"
                           id="quantity"
                           class="form-control"
                           value="1"
                           min="1"
                           th:max="${product.stock}">
                </div>

                <!-- Ïû•Î∞îÍµ¨Îãà Î≤ÑÌäº -->
                <button class="btn btn-dark w-100 py-3 fw-bold"
                        th:onclick="'addToCart(' + ${product.id} + ')'">
                    üõí Ïû•Î∞îÍµ¨Îãà Îã¥Í∏∞
                </button>

                <!-- Î™©Î°ù Î≤ÑÌäº -->
                <a href="/product/list"
                   class="btn btn-outline-secondary w-100 mt-3">
                    ‚Üê Î™©Î°ùÏúºÎ°ú
                </a>

                <!-- Í¥ÄÎ¶¨Ïûê Î≤ÑÌäº -->
                <div class="mt-4 text-end"
                     th:if="${loginUser != null and loginUser.role == 'MANAGER'}">

                    <a th:href="@{/product/form(id=${product.id})}"
                       class="btn btn-sm btn-outline-primary">
                        ÏàòÏ†ï
                    </a>

                    <button class="btn btn-sm btn-outline-danger"
                            th:onclick="'deleteProduct(' + ${product.id} + ')'">
                        ÏÇ≠Ï†ú
                    </button>

                </div>

            </div>

        </div>
    </div>

</div>

<script>
    function deleteProduct(id) {
        if (!confirm("Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;

        fetch("/product/" + id, { method: "DELETE" })
            .then(() => {
                alert("ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
                location.href = "/product/list";
            });
    }

    function addToCart(productId) {
        const quantity = document.getElementById("quantity").value;

        fetch("/cart/add?productId=" + productId + "&quantity=" + quantity, {
            method: "POST"
        }).then(() => {
            if (confirm("Ïû•Î∞îÍµ¨ÎãàÏóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.\nÏû•Î∞îÍµ¨ÎãàÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                location.href = "/cart/list";
            }
        });
    }
    
    function toggleWishlist(productId) {

        fetch("/wishlist/toggle", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "productId=" + productId
        })
        .then(res => {
            if (res.status === 401) {
                alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
                location.href = "/member/login";
                return;
            }
            return res.json();
        })
        .then(liked => {

            const btn = document.getElementById("wishBtn");

            if (liked) {
                btn.innerHTML = "‚ù§Ô∏è Ï∞ú Ï∑®ÏÜå";
                btn.classList.remove("btn-outline-danger");
                btn.classList.add("btn-danger");
            } else {
                btn.innerHTML = "ü§ç Ï∞úÌïòÍ∏∞";
                btn.classList.remove("btn-danger");
                btn.classList.add("btn-outline-danger");
            }

        })
        .catch(err => {
            console.error(err);
            alert("Ïò§Î•ò Î∞úÏÉù");
        });
    }
</script>

<div th:replace="layout/footer :: footer"></div>

</body>
</html>