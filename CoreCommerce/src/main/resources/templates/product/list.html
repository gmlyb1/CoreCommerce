<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout/head :: head"></head>

<style>
/* ìƒí’ˆ ì¹´ë“œ */
.product-card {
    border: none;
    border-radius: 15px;
    transition: all 0.2s ease;
    position: relative;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

/* í’ˆì ˆ ìƒíƒœ */
.out-of-stock {
    opacity: 0.6;
}

/* í’ˆì ˆ ë°°ì§€ */
.out-of-stock::after {
    content: "í’ˆì ˆ";
    position: absolute;
    top: 12px;
    right: 12px;
    background: #dc3545;
    color: #fff;
    padding: 6px 12px;
    font-size: 0.8rem;
    font-weight: bold;
    border-radius: 20px;
}

/* disabled ë²„íŠ¼ UX ê°œì„  */
button:disabled {
    cursor: not-allowed;
    opacity: 0.7;
}
</style>

<body class="d-flex flex-column min-vh-100 bg-light">

<!-- í—¤ë” -->
<div th:replace="layout/header :: header"></div>

<div class="container mt-5 mb-5">

    <h3 class="mb-4 fw-bold">ìƒí’ˆ ëª©ë¡</h3>

	<form method="get" action="/product/list" class="mb-4">

	    <div class="row g-2 align-items-end">
	
	        <div class="col-md-4">
	            <input type="text"
	                   name="keyword"
	                   class="form-control"
	                   placeholder="ìƒí’ˆëª… ê²€ìƒ‰"
	                   th:value="${keyword}">
	        </div>
	
	        <div class="col-md-2">
	            <input type="number"
	                   name="minPrice"
	                   class="form-control"
	                   placeholder="ìµœì†Œ ê°€ê²©"
	                   th:value="${minPrice}">
	        </div>
	
	        <div class="col-md-2">
	            <input type="number"
	                   name="maxPrice"
	                   class="form-control"
	                   placeholder="ìµœëŒ€ ê°€ê²©"
	                   th:value="${maxPrice}">
	        </div>
	
	        <div class="col-md-2">
	            <select name="sort" class="form-select">
				    <option value="latest"
				            th:selected="${sort == 'latest'}">
				        ìµœì‹ ìˆœ
				    </option>
				
				    <option value="price_low"
				            th:selected="${sort == 'price_low'}">
				        ê°€ê²© ë‚®ì€ìˆœ
				    </option>
				
				    <option value="price_high"
				            th:selected="${sort == 'price_high'}">
				        ê°€ê²© ë†’ì€ìˆœ
				    </option>
				</select>
	        </div>
	
	        <div class="col-md-2">
	            <button type="submit" class="btn btn-dark w-100">
	                ğŸ” ê²€ìƒ‰
	            </button>
	        </div>
	
	    </div>
	
	</form>
		

    <div class="row">

        <!-- ìƒí’ˆ ë°˜ë³µ -->
        <div class="col-md-4 mb-4"
             th:each="p : ${products}">

            <div class="card product-card shadow-sm p-3"
                 th:classappend="${p.stock == 0} ? ' out-of-stock'">

                <!-- ìƒí’ˆ ì´ë¯¸ì§€ -->
                <a th:href="@{/product/{id}(id=${p.id})}">
				    <img th:src="${p.imageUrl}"
				         class="card-img-top rounded"
				         style="height: 200px; object-fit: cover; cursor:pointer;">
				</a>

                <div class="card-body text-center">

                    <!-- ìƒí’ˆëª… -->
                    <h5 class="card-title fw-bold"
                        th:text="${p.name}">
                    </h5>

                    <!-- ê°€ê²© -->
                    <p class="text-primary fw-semibold mb-1"
                       th:text="${T(java.lang.String).format('%,dì›', p.price)}">
                    </p>

                    <!-- ì¬ê³  í‘œì‹œ -->
                    <p class="small text-muted mb-2"
                       th:text="'ì¬ê³  : ' + ${p.stock}">
                    </p>

					<button class="btn btn-outline-primary w-100 mb-2"
					        th:disabled="${p.stock == 0}"
					        th:onclick="'addToCart(' + ${p.id} + ')'">
					    ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€
					</button>
					
					<!-- ë°”ë¡œ êµ¬ë§¤ -->
					<button class="btn btn-primary w-100"
					        th:disabled="${p.stock == 0}"
					        th:onclick="'buyNow(' + ${p.id} + ')'">
					    ğŸ’³ ë°”ë¡œ êµ¬ë§¤
					</button>
					<br><br>
                    <!-- ê´€ë¦¬ì ì „ìš© ë²„íŠ¼ -->
                    <div th:if="${loginUser != null and 
                                 (loginUser.role == 'MANAGER' or loginUser.role == 'PRODUCTER')}">

                        <a th:href="@{/product/form(id=${p.id})}"
                           class="btn btn-sm btn-info me-2">
                            ìˆ˜ì •
                        </a>

                        <button class="btn btn-sm btn-danger"
                                th:onclick="'deleteProduct(' + ${p.id} + ')'">
                            ì‚­ì œ
                        </button>

                    </div> 

                </div>
            </div>

        </div>

    </div>
</div>

<!-- ì‚­ì œ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
function deleteProduct(id) {
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    fetch("/product/delete?id=" + id, {
        method: "POST"
    })
    .then(() => {
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.reload();
    })
    .catch(() => {
        alert("ì‚­ì œ ì‹¤íŒ¨");
    });
}

function addToCart(productId){

    fetch("/cart/add?productId=" + productId + "&quantity=1", {
        method: "POST"
    })
    .then(res => res.text())
    .then(() => {
        alert("ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
    })
    .catch(() => alert("ë¡œê·¸ì¸ í•„ìš”"));
}


async function buyNow(productId){

    if(!confirm("ë°”ë¡œ ê²°ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    try {

        // ğŸ”¥ ë‹¨ê±´ ì£¼ë¬¸ ìƒì„± API í˜¸ì¶œ
        const res = await fetch("/order/create-single", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                productId: productId,
                quantity: 1
            })
        });

        if(res.status === 401){
            alert("ë¡œê·¸ì¸ í•„ìš”");
            location.href = "/login";
            return;
        }

        if(!res.ok){
            throw new Error("ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨");
        }

        const orderId = await res.text();

        // ğŸ”¥ ë°”ë¡œ ê²°ì œ í˜ì´ì§€ ì´ë™
        location.href = "/payment?orderId=" + orderId;

    } catch(e){
        alert(e.message);
    }
}


</script>

<!-- í‘¸í„° -->
<div th:replace="layout/footer :: footer"></div>

</body>
</html>