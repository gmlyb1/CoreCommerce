<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout/head :: head"></head>

<body class="d-flex flex-column min-vh-100">

<!-- í—¤ë” -->
<div th:replace="layout/header :: header"></div>

<!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div class="container flex-grow-1 mt-5 mb-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>ìƒí’ˆ ëª©ë¡</h3>

        <div>
            <a th:href="@{/cart/list}" class="btn btn-outline-dark me-2">
                ğŸ›’ ì¥ë°”êµ¬ë‹ˆ
            </a>
            <a th:if="${loginUser.role == 'MANAGER'}" th:href="@{/product/form}" class="btn btn-primary">
                ìƒí’ˆ ë“±ë¡
            </a>
        </div>
    </div>

    <div class="row row-cols-1 row-cols-md-3 g-4">
        <div class="col" th:each="p : ${products}">
            <div class="card h-100 shadow-sm">

                <!-- ìƒí’ˆ ì´ë¯¸ì§€ -->
                <img th:src="${p.imageUrl}"
                     class="card-img-top"
                     style="height:200px; object-fit:cover;"
                     alt="ìƒí’ˆ ì´ë¯¸ì§€">

                <div class="card-body">

                    <!-- ìƒí’ˆëª… -->
                    <h5 class="card-title" th:text="${p.name}">ìƒí’ˆëª…</h5>

                    <!-- ìƒí’ˆ ì„¤ëª… -->
                    <p class="card-text text-truncate"
                       th:text="${p.description}">
                        ì„¤ëª…
                    </p>

                    <!-- ê°€ê²© -->
                    <p class="mb-1">
                        <strong th:text="${T(java.lang.String)
                        .format('%,dì›', p.price)}">
                        </strong>
                    </p>

                    <!-- ì¬ê³  -->
                    <p class="mb-0 text-muted"
                       th:text="'ì¬ê³ : ' + ${p.stock}">
                        ì¬ê³ 
                    </p>

                </div>

                <div class="card-footer d-flex justify-content-between">

                    <a th:if="${loginUser.role == 'MANAGER'}"
                       th:href="@{/product/form(id=${p.id})}"
                       class="btn btn-sm btn-info">
                        ìˆ˜ì •
                    </a>

                    <button class="btn btn-sm btn-danger"
                            th:onclick="'deleteProduct(' + ${p.id} + ')'"
                            th:if="${loginUser.role == 'MANAGER'}"
                            >
                        ì‚­ì œ
                    </button>

                    <button class="btn btn-sm btn-success"
                            th:onclick="'addToCart(' + ${p.id} + ', 1)'">
                        ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
                    </button>

                </div>
            </div>
        </div>
    </div>

    <!-- ìƒí’ˆ ì—†ì„ ë•Œ -->
    <div class="mt-4 text-center"
         th:if="${#lists.isEmpty(products)}">
        <p class="text-muted">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>

</div>

<!-- í‘¸í„° -->
<div th:replace="layout/footer :: footer"></div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>

    async function deleteProduct(id) {
        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            await axios.delete(`/product/${id}`);
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            location.reload();
        } catch (err) {
            console.error(err);
            alert(err.response?.data?.message || 'ì‚­ì œ ì‹¤íŒ¨');
        }
    }

    async function addToCart(productId, quantity) {
        try {

            await axios.post('/cart/add', null, {
                params: {
                    productId: productId,
                    quantity: quantity
                }
            });

            if (confirm('ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.\nì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                location.href = '/cart/list';
            }

        } catch (err) {
            console.error(err);
            alert(err.response?.data?.message || 'ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ì‹¤íŒ¨');
        }
    }

</script>

</body>
</html>