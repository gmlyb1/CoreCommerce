<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/head :: head"></head>

<body>

<div th:replace="layout/header :: header"></div>

<div class="container mt-5">

    <h3>📦 관리자 주문 관리</h3>

    <table class="table table-bordered text-center mt-4">
        <thead class="table-dark">
        <tr>
            <th>주문번호</th>
            <th>회원ID</th>
            <th>총금액</th>
            <th>상태</th>
            <th>변경</th>
        </tr>
        </thead>

        <tbody>

        <tr th:each="order : ${orders}">
            <td th:text="${order.id}"></td>
            <td th:text="${order.email}"></td>
            <td th:text="${order.totalPrice}"></td>

            <td>
                <span class="badge bg-primary"
                      th:text="${order.status}">
                </span>
            </td>

           <td>

		    <!-- 상태 -->
		   <select th:id="'status-' + ${order.id}" class="form-select mb-2">
			    <option th:each="s : ${T(java.util.Arrays).asList('READY','PAID','SHIPPED','CANCELLED')}"
			            th:value="${s}"
			            th:text="${s}"
			            th:selected="${order.status == s}">
			    </option>
			</select>
		
		    <!-- 택배사 -->
		    <select th:id="'courier-' + ${order.id}" class="form-select mb-2">
			    <option value="" th:selected="${order.courier == null or order.courier == ''}">
			        택배사 선택
			    </option>
			    <option value="CJ대한통운" th:selected="${order.courier == 'CJ대한통운'}">
			        CJ대한통운
			    </option>
			    <option value="한진택배" th:selected="${order.courier == '한진택배'}">
			        한진택배
			    </option>
			    <option value="롯데택배" th:selected="${order.courier == '롯데택배'}">
			        롯데택배
			    </option>
			    <option value="우체국" th:selected="${order.courier == '우체국'}">
			        우체국
			    </option>
			</select>
		
		    <!-- 송장 번호 -->
		    <input type="text"
			       th:id="'tracking-' + ${order.id}"
			       class="form-control mb-2"
			       placeholder="송장번호 입력"
			       th:value="${order.trackingNumber}">
		
		    <!-- 변경 버튼 -->
		    <button class="btn btn-sm btn-success"
		            th:onclick="'updateStatus(' + ${order.id} + ')'">
		        변경
		    </button>
		
		</td>

        </tr>

        </tbody>
    </table>
	
	<!-- ================= 페이징 ================= -->
	<div class="mt-4"
	     th:if="${pagination != null and pagination.totalPages > 1}">
	
	    <ul class="pagination justify-content-center d-flex flex-row">
	
	        <li class="page-item"
	            th:classappend="${pagination.first} ? 'disabled'">
	
	            <a class="page-link"
	               th:href="@{/admin/orders(page=${pagination.page - 1})}">
	                ‹
	            </a>
	        </li>
	
	        <li class="page-item"
	            th:each="i : ${#numbers.sequence(1, pagination.totalPages)}"
	            th:classappend="${i == pagination.page} ? 'active'">
	
	            <a class="page-link"
	               th:href="@{/admin/orders(page=${i})}"
	               th:text="${i}">
	            </a>
	
	        </li>
	
	        <li class="page-item"
	            th:classappend="${pagination.last} ? 'disabled'">
	
	            <a class="page-link"
	               th:href="@{/admin/orders(page=${pagination.page + 1})}">
	                ›
	            </a>
	        </li>
	
	    </ul>
	
	</div>


</div>

<script>

function updateStatus(orderId){

    const status = document.getElementById("status-" + orderId).value;
    const courier = document.getElementById("courier-" + orderId).value;
    const tracking = document.getElementById("tracking-" + orderId).value;

    fetch("/admin/orders/status", {
        method : "POST",
        headers : {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body :
            "orderId=" + orderId +
            "&status=" + status +
            "&courier=" + courier +
            "&trackingNumber=" + tracking
    })
    .then(res => res.text())
    .then(() => {
        alert("주문 정보 업데이트 완료");
        location.reload();
    });

}

</script>

</body>
</html>